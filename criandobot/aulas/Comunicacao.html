<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Criando bot</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="shortcut icon" href="/CriandoBot/assets/img/favicon.ico">
    <link rel="icon" href="/CriandoBot/assets/img/favicon.ico">
    <link rel="apple-touch-icon" href="/CriandoBot/assets/img/logo.png">
    <link rel="mask-icon" href="/CriandoBot/assets/img/logo.png" color="#3eaf7c">
    <meta name="description" content="Criador do Projeto: VycktorStark">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/CriandoBot/assets/css/0.styles.af084dce.css" as="style"><link rel="preload" href="/CriandoBot/assets/js/app.8edf5945.js" as="script"><link rel="preload" href="/CriandoBot/assets/js/2.a13100e2.js" as="script"><link rel="preload" href="/CriandoBot/assets/js/7.01b30525.js" as="script"><link rel="preload" href="/CriandoBot/assets/js/3.ae6ec04c.js" as="script"><link rel="prefetch" href="/CriandoBot/assets/js/4.2f529c62.js"><link rel="prefetch" href="/CriandoBot/assets/js/5.83bc0aa3.js"><link rel="prefetch" href="/CriandoBot/assets/js/6.df9adbdf.js"><link rel="prefetch" href="/CriandoBot/assets/js/8.a9f793f7.js"><link rel="prefetch" href="/CriandoBot/assets/js/9.3e1d2ca7.js">
    <link rel="stylesheet" href="/CriandoBot/assets/css/0.styles.af084dce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CriandoBot/" class="home-link router-link-active"><!----> <span class="site-name">Criando bot</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu de Aulas" class="dropdown-title"><span class="title">Aulas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CriandoBot/" class="nav-link">
  Introdução
</a></li><li class="dropdown-item"><!----> <a href="/CriandoBot/criandobot/aulas/Piloto.html" class="nav-link">
  Primeira Aula
</a></li><li class="dropdown-item"><!----> <a href="/CriandoBot/criandobot/aulas/Comunicacao.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Segunda Aula
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/VycktorStark/CriandoBot/tree/master/Projeto" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Projeto
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://app.picpay.com/VycktorStark" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Patrocinar
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu de Aulas" class="dropdown-title"><span class="title">Aulas</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CriandoBot/" class="nav-link">
  Introdução
</a></li><li class="dropdown-item"><!----> <a href="/CriandoBot/criandobot/aulas/Piloto.html" class="nav-link">
  Primeira Aula
</a></li><li class="dropdown-item"><!----> <a href="/CriandoBot/criandobot/aulas/Comunicacao.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Segunda Aula
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/VycktorStark/CriandoBot/tree/master/Projeto" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Projeto
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://app.picpay.com/VycktorStark" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Patrocinar
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main aria-labelledby="main-title" class="home"><header class="hero"><!----> <!----> <!----> <!----></header> <!----> <div class="theme-default-content custom content__default"><h1 id="aula-teorica-comunicacao-com-api-telegram-bot"><a href="#aula-teorica-comunicacao-com-api-telegram-bot" class="header-anchor">#</a> Aula teórica - Comunicação com API-TELEGRAM-BOT</h1> <p>Comunicação com API-TELEGRAM-BOT, como receber e responder uma solicitação.</p> <p>A comunicação entre seu projeto com a <a href="https://core.telegram.org/bots/api" target="_blank" rel="noopener noreferrer">API-TELEGRAM-BOT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> é extremamente importante. Precisamos entender como esta comunicação funciona, para que possamos criar nossos projetos. Precisamos saber que ela é dividida em duas partes: A primeira enviando dados e a outra recebendo dados.</p> <p>Na aula inicial, vimos como criar uma maneira de tratar a primeira parte dessa comunicação. Enviando mensagens, arquivos e manipulando todo e qualquer método da <a href="https://core.telegram.org/bots/api" target="_blank" rel="noopener noreferrer">API-TELEGRAM-BOT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>; Agora precisamos entender a segunda parte:</p> <p>Recebimento de dados: Quando um usuário executa alguma ação no bot, ele espera por uma resposta. E para responder, precisamos saber o que é e quais são os dados dessa ação.</p> <h3 id="como-recebemos-dados-da-api-telegram-bot"><a href="#como-recebemos-dados-da-api-telegram-bot" class="header-anchor">#</a> Como recebemos dados da <a href="https://core.telegram.org/bots/api" target="_blank" rel="noopener noreferrer">API-TELEGRAM-BOT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>?</h3> <p>De acordo com o site oficial, <a href="https://core.telegram.org/bots/api#getting-updates" target="_blank" rel="noopener noreferrer">há duas maneiras de receber as informações<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: Por webhook e por long polling.</p> <p>Fique tranquilo, pois iremos abordar essas duas maneiras de forma separada.</p> <hr> <h3 id="long-polling"><a href="#long-polling" class="header-anchor">#</a> Long Polling</h3> <h4 id="o-que-e-long-polling"><a href="#o-que-e-long-polling" class="header-anchor">#</a> O que é Long Polling?</h4> <p>É uma técnica <a href="https://pt.wikipedia.org/wiki/Comet_(programa%C3%A7%C3%A3o)" target="_blank" rel="noopener noreferrer">comet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, que permite que a conexão fique aberta, aguardando uma resposta do servidor, quando a conexão recebe uma resposta, caso seja necessário tratamos ela, logo em seguida ela é fechada (independentemente se houver algo para ser tratado ou não). Depois, essa conexão é reaberta e inicia-se um novo <a href="https://pt.wikipedia.org/wiki/Loop_(programa%C3%A7%C3%A3o)" target="_blank" rel="noopener noreferrer">loop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <ul><li><a href="https://rodolfofadino.com.br/usando-long-polling-com-asynccontrollers-a72e15db2f9e" target="_blank" rel="noopener noreferrer">Mais detalhes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li></ul> <h3 id="trabalhando-com-long-polling"><a href="#trabalhando-com-long-polling" class="header-anchor">#</a> Trabalhando com Long Polling</h3> <p>Para trabalharmos com Long Polling precisamos criar uma função que faça conexão com o método <a href="https://core.telegram.org/bots/api#getupdates" target="_blank" rel="noopener noreferrer">getUpdates<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> para isso usaremos o manipulador de métodos da API que abordamos na aula passada.</p> <p>Nota: O objetivo das aulas não é ensinar programação. No entanto, deixarei um exemplo abaixo, de como devemos criar essa funcionalidade.</p> <ul><li>Lembre-se de adicionar sua token do bot ao manipulador de métodos.</li></ul> <p>Usarei essa funcionalidade para o Long Polling:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> Method<span class="token punctuation">,</span> json
<span class="token keyword">def</span> <span class="token function">longpolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Essa funcionalidade permitirá que você faça checagem de novas ações e colete os dados,
    caso houver, ela retornará o que encontrar, caso não tenha nada, ela retornará algo pré-definido
    isso fará com que o loop não seja interrompido.
    &quot;&quot;&quot;</span>
    temp <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">&quot;getUpdates&quot;</span><span class="token punctuation">,</span> offset<span class="token operator">=</span>temp<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>temp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowed_updates<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">]</span> 
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            resp <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>ping<span class="token operator">=</span><span class="token string">'pong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#Estou definido algo para retorna, caso não encontre resultados</span>
        <span class="token keyword">elif</span> <span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            temp  <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'update_id'</span><span class="token punctuation">]</span>  <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#Aumentando o tempo</span>
            resp <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> resp
</code></pre></div><p>Agora, precisamos tratar o que foi retornado. Então, criaremos algo para responder.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> Method<span class="token punctuation">,</span>json
api <span class="token operator">=</span> Method<span class="token punctuation">.</span>Method<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>vetor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Essa função receberá eventos, porém só irá fazer o tratamento dos evento que possuam a chave: &quot;message&quot;; no vetor;  
    caso seja encontrado essa chave, responderá com a palavra: PONG
    Nota: os retornos de resposta são apenas exemplos, você pode alterar ou adicionar da maneira que preferir.
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span> <span class="token keyword">in</span> vetor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> vetor<span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'text'</span> <span class="token keyword">in</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
            api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>chat_id<span class="token operator">=</span>msg<span class="token punctuation">[</span><span class="token string">'chat'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">'PONG'</span><span class="token punctuation">)</span>
</code></pre></div><p>Ok, vamos unificar as duas funções para trabalharem no mesmo script.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> Method<span class="token punctuation">,</span>json
api <span class="token operator">=</span> Method<span class="token punctuation">.</span>Method<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">longpolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Essa funcionalidade permitirá que você faça checagem de novas ações e colete os dados,
    caso houver, ela retornará o que encontrar, caso não tenha nada, ela retornará algo pré-definido
    isso fará com que o loop não seja interrompido.
    &quot;&quot;&quot;</span>
    temp <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">&quot;getUpdates&quot;</span><span class="token punctuation">,</span> offset<span class="token operator">=</span>temp<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>temp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allowed_updates<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">]</span> 
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            resp <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>ping<span class="token operator">=</span><span class="token string">'pong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#Estou definido algo para retorna, caso não encontre resultados</span>
        <span class="token keyword">elif</span> <span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            temp  <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'update_id'</span><span class="token punctuation">]</span>  <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#Aumentando o tempo</span>
            resp <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        handler<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>vetor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Essa função receberá eventos, porém só irá fazer o tratamento dos evento que possuam a chave: &quot;message&quot;; no vetor;  
    caso seja encontrado essa chave, responderá com a palavra: PONG
    Nota: os retornos de resposta são apenas exemplos, você pode alterar ou adicionar da maneira que preferir.
    &quot;&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span> <span class="token keyword">in</span> vetor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'text'</span> <span class="token keyword">in</span> vetor<span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>chat_id<span class="token operator">=</span>vetor<span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'chat'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">'PONG'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Iniciando o bot&quot;</span><span class="token punctuation">)</span>
        longpolling<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#Chamando a função para iniciar o long polling</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span> <span class="token comment">#Caso vocÊ execute: CTRL C</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\nEncerrando o bot&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Pronto, já temos o nosso bot rodando via polling e respondendo todos os evento com a chave &quot;message&quot;, em outras aulas criaremos novos recursos.</p> <hr> <h3 id="webhook"><a href="#webhook" class="header-anchor">#</a> Webhook</h3> <h4 id="o-que-e-webhook"><a href="#o-que-e-webhook" class="header-anchor">#</a> O que é Webhook?</h4> <p>Webhooks são retornos de chamada HTTP e/ou HTTPS em seu servidor web, esse sistema possui uma flexibilidade para integrar fluxo para essas chamadas de maneira que conseguimos tratar cada chamada que recebemos, sendo ele um sistema impressionantemente simples de implementar em qualquer linguagem de programação.</p> <ul><li><a href="https://pt.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener noreferrer">Mais detalhes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="trabalhando-com-webhook"><a href="#trabalhando-com-webhook" class="header-anchor">#</a> Trabalhando com Webhook</h3> <p>Basicamente, quando definimos para a <a href="https://core.telegram.org/bots/api" target="_blank" rel="noopener noreferrer">API-TELEGRAM-BOT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> que iremos receber todas as novas requisições por webhook, o próprio Telegram encarrega-se de fazer chamadas carregando informações das ações executadas pelo usuários em nosso servidor web, restando apenas tratar essas informações e, para isso devemos subir um servidor web em nossa máquina e montar uma função para manipular as chamadas recebidas, mais uma vez usaremos o script que criamos na aula passada.</p> <p>Nota: O objetivo das aulas não é ensinar programação. No entanto, deixarei um exemplo abaixo de como devemos criar essa funcionalidade. Lembre-se de adicionar sua token do bot ao manipulador de métodos. Falando sobre subir um servidor web, fique tranquilo, você pode usar o <a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer">ngrok<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (Inclusive, nessa aula
iremos usá-lo).</p> <p>Primeiramente, precisamos deixar nosso servidor web online, <a href="https://ngrok.com/download" target="_blank" rel="noopener noreferrer">clique aqui<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> e, siga as instruções para fazer download do arquivo e descompactá-lo, agora com o arquivo descompactado, abra seu terminal na pasta onde ele está e execute: ngrok http 8443, ele vai gerar um link com HTTP e HTTPS, minimize o terminal e deixe rodando em segundo plano.</p> <p>Agora vamos criar o nosso script para manipular as chamadas recebidas, usaremos a biblioteca <a href="https://flask.palletsprojects.com/en/1.1.x/" target="_blank" rel="noopener noreferrer">Flask<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> uma vez que na minha opinião é a melhor para
trabalharmos chamadas recebidas. Abaixo um exemplo de uso dessa
biblioteca.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> flask<span class="token punctuation">,</span> Method<span class="token punctuation">,</span> json
api <span class="token operator">=</span> Method<span class="token punctuation">.</span>Method<span class="token punctuation">(</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> flask<span class="token punctuation">.</span>Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">server_error</span><span class="token punctuation">(</span>errorhandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Se ocorrer algum erro com o código 404, a função abaixo será executada,
    onde retornaremos o status 200 para eliminar toda e qualquer solicitação!

    Porque? o webhook cria um tipo de loop, onde sempre repetirá a solicitação até seja tratada como status 200,
    isto é, ele só encerra o loop quando recebe uma mensagem bem-sucedida de que, por padrão, possui o status 200,
    Basicamente, isso resolverá o problema!
    &quot;&quot;&quot;</span>
    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>before_request</span>
<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">&quot;/webhookstart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        A partir daqui ele será lido apenas se o método de solicitação for &quot;GET&quot; e, 
        se o caminho for igual a &quot;/webhookstart&quot;, se essas variáveis ​​forem verdadeiras, esse script 
        executará uma funcionalidade na API-TELEGRAM-BOT que fará com que a host seja reconhecida pelo flask
        e, receba novos eventos do bot, ou seja, todas as novas solicitações serão enviadas apenas para o host detectável pelo &quot;flask&quot;
        Nota: Caso esteja usando o ngrok não se preocupe em ter que alterar o HTTPS no código, 
        quando você executar o ngrok, ele gerará um link HTTPS, certo? acesse ele e adicione no final /webhookstart
        exemplo: gerou o link: &quot;https://232ih3h.ngrok.com&quot;, então você deverá acessar o link  https://232ih3h.ngrok.com/webhookstart
        &quot;&quot;&quot;</span>
        r <span class="token operator">=</span> api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">&quot;setWebhook&quot;</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>host<span class="token punctuation">}</span></span><span class="token string">/webhook&quot;</span></span><span class="token punctuation">,</span> max_connections<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> allowed_updates<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>response<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'description'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">&quot;/webhook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        A partir daqui será lido apenas se o método de solicitação for &quot;POST&quot; (padrão das chamadas do Telegram)
        e, se o caminho for igual a &quot;/webhook&quot;, se essas variáveis ​​forem verdadeiras, o script irár ler os eventos,
        caso haja um evento com a chave: &quot;messsage&quot;; ele responderá com a palavra: PONG
        Estou usando essa palavra apenas para saber que o script está funcionando, você poderá usar outra coisa
        &quot;&quot;&quot;</span>
        vetor <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span>silent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> force<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># lendo os eventos recebido pela chamada</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span> <span class="token keyword">in</span> vetor<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'text'</span> <span class="token keyword">in</span> vetor<span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                api<span class="token punctuation">.</span>sendTG<span class="token punctuation">(</span>chat_id<span class="token operator">=</span>vetor<span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'chat'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">'PONG'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
  app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8443</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span> <span class="token comment">#Running app</span>
</code></pre></div><p>Concluímos esta aula, aprendemos como funciona o recebimento de dados para novas ações por meio do long polling e webhook, criamos um script que faz o bot responder a essas novas ações e identifica as informações dela, em breve aprenderemos como usar todos os métodos <a href="https://core.telegram.org/bots/api" target="_blank" rel="noopener noreferrer">API-TELEGRAM-BOT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="footer">
    Hosted by GitHub Pages | MIT Licensed | Website Environment by Roberto Monteiro
  </div></main></div><div class="global-ui"><!----></div></div>
    <script src="/CriandoBot/assets/js/app.8edf5945.js" defer></script><script src="/CriandoBot/assets/js/2.a13100e2.js" defer></script><script src="/CriandoBot/assets/js/7.01b30525.js" defer></script><script src="/CriandoBot/assets/js/3.ae6ec04c.js" defer></script>
  </body>
</html>
